<!-- 
Version: v1.1.5
Changes:
- SpeechRecognition + MediaRecorder run together (parallel)
- Recognition used for correction (✅/❌ words, extras, accuracy)
- Recording runs at same time, playback shown after stop
- Status label updated: Listening / Processing / Done
- Works for both desktop + mobile (Chrome/Android)
-->
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Kids Sentence Reader - Rocket Launch</title>
  <style>
    html, body {
      margin: 0; padding: 0;
      min-height: 100vh;
      font-family: Arial, sans-serif;
      background: linear-gradient(to top, #001f3f, #87ceeb);
      display: flex; flex-direction: column;
      align-items: center; justify-content: flex-start;
      text-align: center;
    }
    h1 { color: white; font-size: clamp(24px, 6vw, 38px); margin: 12px; }

    #sentence {
      font-size: clamp(28px, 8vw, 54px);
      font-weight: bold; color: white;
      background: rgba(0,0,0,0.6); border-radius: 12px;
      padding: 8px 14px; max-width: 95%; margin: 12px auto;
      opacity: 0; transition: opacity 1s ease;
    }

    #status { margin: 6px; font-size: 16px; font-weight: bold; color: yellow; }

    #results { display: none; margin: 10px auto; padding: 12px;
      background: rgba(0,0,0,0.5); border-radius: 14px;
      max-width: 95%; word-wrap: break-word; }
    #spoken { font-size: clamp(20px, 6vw, 32px); font-weight: bold; color: #fffacd; margin-top: 6px; }
    #extras { font-size: clamp(18px, 5vw, 28px); color: orange; margin-top: 6px; }

    #accuracy { margin-top: 10px; width: 80%; max-width: 400px; height: 30px;
      background: #ddd; border-radius: 20px; overflow: hidden; position: relative; }
    #accuracy-bar { height: 100%; width: 0%; background: linear-gradient(135deg, #ffcc00, #ff6600); transition: width 1s ease; }
    #accuracy-label { position: absolute; top: 0; left: 50%; transform: translateX(-50%); font-weight: bold; color: black; }

    .correct { background: lightgreen; color: black; border-radius: 6px; padding: 2px 4px; }
    .wrong { background: #ff4e4e; color: white; border-radius: 6px; padding: 2px 4px; }
    .extra { background: orange; color: white; border-radius: 6px; padding: 2px 4px; }

    #sky { position: relative; flex: 1; width: 100%; max-width: 600px;
      display: flex; flex-direction: column; justify-content: flex-end; }
    .rocket { width: 60px; height: 120px; margin: auto; position: relative; bottom: 0;
      transition: bottom 1s ease-in; z-index: 1; }
    .rocket::before { content: "🚀"; font-size: 80px; position: absolute; top: -10px; left: -5px; }
    .flames { position: absolute; bottom: 5px; left: 50%; transform: translateX(-50%); opacity: 0; }
    .flame-cone { width: 0; height: 0; border-left: 14px solid transparent;
      border-right: 14px solid transparent; border-top: 40px solid orange;
      animation: flicker 0.2s infinite alternate; }
    .flame-cone.yellow { border-left: 10px solid transparent; border-right: 10px solid transparent;
      border-top: 28px solid yellow; margin-top: -12px; }
    @keyframes flicker { from { transform: scaleY(1); opacity: 0.8; } to { transform: scaleY(1.2); opacity: 1; } }

    .launch-btn { width: 180px; height: 65px; border-radius: 14px;
      background: linear-gradient(135deg, #ff512f, #dd2476);
      color: white; font-size: 24px; font-weight: bold; border: none; cursor: pointer; margin: 10px 0; }
    .button-container { display: flex; gap: 20px; justify-content: center; margin: 10px 0 20px; flex-wrap: wrap; }
    .round-btn { width: 90px; height: 90px; border-radius: 50%; font-size: 26px; border: none; cursor: pointer; color: white; }
    .speak-btn { background: linear-gradient(135deg, #00c6ff, #0072ff); }
    .listen-btn { background: linear-gradient(135deg, #28a745, #218838); }
    .stop-btn { background: linear-gradient(135deg, #ff0000, #cc0000); }

    footer { font-size: 10px; color: rgba(255,255,255,0.6); position: fixed; bottom: 4px; left: 8px; font-family: monospace; }
  </style>
</head>
<body>
  <h1>🚀 Launch the Rocket to Read! 🚀</h1>
  <div id="sentence">Press Launch!</div>
  <div id="status"></div>

  <div id="results">
    <div id="spoken"></div>
    <div id="extras"></div>
    <div id="accuracy">
      <div id="accuracy-bar"></div>
      <div id="accuracy-label">0/10</div>
    </div>
    <audio id="playback" controls style="display:none"></audio>
  </div>

  <div id="sky">
    <div class="rocket" id="rocket">
      <div class="flames" id="flames">
        <div class="flame-cone orange"></div>
        <div class="flame-cone yellow"></div>
      </div>
    </div>
  </div>

  <button class="launch-btn" onclick="launchRocket()">🚀 Launch</button>
  <div class="button-container">
    <button class="round-btn speak-btn" onclick="speakSentence()">🔊</button>
    <button class="round-btn listen-btn" onclick="startListening()">🎤</button>
    <button class="round-btn stop-btn" onclick="stopListening()">🛑</button>
  </div>

  <audio id="rocketRoar" src="https://actions.google.com/sounds/v1/transportation/rocket_launch.ogg"></audio>
  <audio id="kidsCheer" src="https://actions.google.com/sounds/v1/crowds/children_cheer.ogg"></audio>

  <footer>v1.1.5</footer>

  <script>
    const sentences = [
      "The cat is sleeping on bed.",
      "She is reading a small book.",
      "We are playing with a red ball.",
      "The dog runs across the park.",
      "Birds are flying high in sky.",
      "A boy is eating sweet mango."
    ];
    let currentSentence = "";
    let recognition, transcripts = [];
    let mediaRecorder, audioChunks = [];

    function getRandomSentence() {
      return sentences[Math.floor(Math.random() * sentences.length)];
    }
    function setStatus(text) { document.getElementById("status").textContent = text; }

    function launchRocket() {
      const rocket = document.getElementById("rocket");
      const flames = document.getElementById("flames");
      const sentenceEl = document.getElementById("sentence");
      document.getElementById("results").style.display = "none";
      setStatus("");

      flames.style.opacity = 1;
      rocket.style.bottom = "180px";  
      document.getElementById("rocketRoar").play();

      setTimeout(() => {
        flames.style.opacity = 0;
        rocket.style.bottom = "0px";
        currentSentence = getRandomSentence();
        sentenceEl.textContent = currentSentence;
        sentenceEl.style.opacity = 1;
        document.getElementById("kidsCheer").play();
      }, 1200);
    }

    function speakSentence() {
      if (!currentSentence) return;
      const msg = new SpeechSynthesisUtterance(currentSentence);
      msg.lang = "en-IN"; msg.rate = 0.6; msg.pitch = 1.0;
      speechSynthesis.cancel(); speechSynthesis.speak(msg);
    }

    function startListening() {
      if (!currentSentence) { alert("Launch the rocket first!"); return; }
      if (recognition) recognition.stop();
      transcripts = [];
      setStatus("🎤 Listening...");

      recognition = new (window.SpeechRecognition || window.webkitSpeechRecognition)();
      recognition.lang = "en-IN"; recognition.interimResults = false; recognition.continuous = true;

      let silenceTimer;
      recognition.onresult = (event) => {
        for (let i = event.resultIndex; i < event.results.length; ++i) {
          if (event.results[i].isFinal) transcripts.push(event.results[i][0].transcript.trim());
        }
        clearTimeout(silenceTimer);
        silenceTimer = setTimeout(() => recognition.stop(), 4000);
      };

      recognition.onend = async () => {
        if (transcripts.length > 0) {
          setStatus("⏳ Processing...");
          let longest = transcripts.reduce((a, b) => (b.split(" ").length > a.split(" ").length ? b : a));
          showComparison(currentSentence, longest);
          setStatus("✅ Done");

          // 🎙️ Start recording AFTER recognition finished
          try {
            const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
            mediaRecorder = new MediaRecorder(stream);
            audioChunks = [];
            mediaRecorder.ondataavailable = e => audioChunks.push(e.data);
            mediaRecorder.onstop = () => {
              const audioBlob = new Blob(audioChunks, { type: "audio/webm" });
              const audioUrl = URL.createObjectURL(audioBlob);
              const playback = document.getElementById("playback");
              playback.src = audioUrl; playback.style.display = "block"; playback.load();
            };
            mediaRecorder.start();
            setTimeout(() => mediaRecorder.stop(), 3000); // short snippet
          } catch (err) { setStatus("⚠️ Mic error: " + err.message); }
        } else {
          setStatus("⚠️ No speech detected");
        }
      };

      recognition.onerror = (e) => setStatus("⚠️ Error: " + e.error);
      recognition.start();
    }

    function stopListening() {
      setStatus("⏳ Stopping...");
      if (recognition) recognition.stop();
      if (mediaRecorder && mediaRecorder.state !== "inactive") mediaRecorder.stop();
    }

    function showComparison(expected, spoken) {
      document.getElementById("results").style.display = "block";
      const expectedWords = expected.toLowerCase().replace(/[^\w\s]/g, "").split(" ");
      const spokenWords = spoken.toLowerCase().replace(/[^\w\s]/g, "").split(" ");

      let resultHTML = "", correctCount = 0;
      expectedWords.forEach(word => {
        if (spokenWords.includes(word)) { resultHTML += `<span class="correct">${word}</span> `; correctCount++; }
        else { resultHTML += `<span class="wrong">${word}</span> `; }
      });

      document.getElementById("sentence").innerHTML = resultHTML.trim();
      document.getElementById("spoken").textContent = "You said: " + spoken;

      let extras = spokenWords.filter(w => !expectedWords.includes(w));
      document.getElementById("extras").innerHTML = extras.length > 0 ? "Extras: " + extras.map(w => `<span class="extra">${w}</span>`).join(" ") : "";

      let accuracy = Math.round((correctCount / expectedWords.length) * 10);
      document.getElementById("accuracy-bar").style.width = (accuracy * 10) + "%";
      document.getElementById("accuracy-label").textContent = accuracy + "/10";
    }
  </script>
</body>
</html>
